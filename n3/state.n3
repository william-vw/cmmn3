@prefix in: <http://n3.w3c.org/builtin/input#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cond: <http://rdf.org/cond#> .
@prefix e: <http://eulersharp.sourceforge.net/2003/03swap/log-rules#>.
@prefix state: <http://rdf.org/state#> .
@prefix cm: <http://rdf.org/cmmn#> .

# interface

{   ?item state:transit ( ?curType ?nextType ?reason ?nextState ) }
<= {
    ?item state:cur ( ?curType ?curState ) .
    ?curState state:next ( ?nextType ?reason ?nextState ) .
} .

{   ?item state:isIn ?stateType }
<= { ?item state:cur ( ?stateType ?s ) } .

# implementation

{   ?planItem state:cur ( ?curType ( ?curType ?curReason ?curId ) ) } 
<= {
    ?planItem a cm:PlanItem .
    ( ?someId { ?planItem state:in ( ?someType ?someReason ?someId ) } ?ids )
        log:collectAllIn _:t .

    ?ids e:max ?curId .
    ?planItem state:in ( ?curType ?curReason ?curId ) .
} .

{   ( ?curType ?curReason ?curId ) state:next (?nextType ?reason ( ?nextType ?reason ?nextId ) ) }
<= {
    ( ?curId 1 ) math:sum ?nextId .
} .