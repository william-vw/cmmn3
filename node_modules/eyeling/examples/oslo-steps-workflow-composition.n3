# =======================================================================================
# OSLO-STEPS — minimal “Address change” workflow composition example
#
# Purpose
#   A compact, representative test case for Eyeling/EYE workflow composition in the
#   OSLO-STEPS style, without SHACL or shape machinery.
#
# What it models
#   A citizen (Bob) completes an address change. The workflow progresses through five
#   “state flags”:
#     1) personalInfoProvided
#     2) movingDataProvided
#     3) newAddressProvided
#     4) addressChangeDeclared
#     5) confirmationOfAddressChange
#
# OSLO-STEPS core used
#   - Each action is an o-steps:Step with:
#       o-steps:requiresState  (precondition state)
#       o-steps:producesState  (postcondition state)
#     plus simple costs:
#       cost:duration, cost:monetaryCost, cost:success, cost:usersatifaction
#
# State representation
#   - Each “State” is stored as a quoted N3 formula term in state:si :formula { ... }.
#   - We use var:x inside formulas as a stable placeholder to avoid variable-renaming
#     explosions and to keep formula-term matching predictable across engines.
#
# Compilation and planning
#   - A small compiler turns each o-steps:Step into a gps:description transition:
#       (FROM true TO STEP duration cost success satisfaction)
#   - A minimal planner composes gps:description transitions into a gps:path by chaining
#     them and aggregating metrics:
#       duration + monetaryCost  = sum
#       success  * satisfaction  = product
#   - No “fuel” bound is used here; termination is ensured because the workflow graph is
#     acyclic (s0 -> s1 -> s2 -> s3 -> s4 -> s5) and has a finite number of alternatives.
#
# Output
#   - Derives :bob gps:path ( ?Steps ?Duration ?Cost ?Success ?Satisfaction ).
#
# Run (examples)
#   eye --quiet --nope --pass-only-new oslo-steps-workflow-composition-min.n3
#   node eyeling.js oslo-steps-workflow-composition-min.n3
# =======================================================================================

@prefix math: <http://www.w3.org/2000/10/swap/math#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix gps:  <https://eyereasoner.github.io/eye/reasoning/gps/gps-schema#>.
@prefix :     <https://eyereasoner.github.io/eye/reasoning#>.

@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix var:  <http://www.w3.org/2000/10/swap/var#>.

@prefix o-steps:   <https://fast.ilabt.imec.be/ns/oslo-steps#>.
@prefix o-persoon: <https://data.vlaanderen.be/ns/persoon#>.

@prefix ex:    <https://example.org/vocab#>.
@prefix cost:  <https://example.org/cost#>.
@prefix state: <https://example.org/states#>.
@prefix step:  <https://example.org/steps#>.

# =======================================================================================
# 1) States as formula terms (no SHACL)
# =======================================================================================

# Start (all false)
state:s0 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        false.
  var:x ex:movingDataProvided          false.
  var:x ex:newAddressProvided          false.
  var:x ex:addressChangeDeclared       false.
  var:x ex:confirmationOfAddressChange false.
}.

# Personal info done
state:s1 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        true.
  var:x ex:movingDataProvided          false.
  var:x ex:newAddressProvided          false.
  var:x ex:addressChangeDeclared       false.
  var:x ex:confirmationOfAddressChange false.
}.

# Moving data done
state:s2 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        true.
  var:x ex:movingDataProvided          true.
  var:x ex:newAddressProvided          false.
  var:x ex:addressChangeDeclared       false.
  var:x ex:confirmationOfAddressChange false.
}.

# New address done
state:s3 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        true.
  var:x ex:movingDataProvided          true.
  var:x ex:newAddressProvided          true.
  var:x ex:addressChangeDeclared       false.
  var:x ex:confirmationOfAddressChange false.
}.

# Declared
state:s4 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        true.
  var:x ex:movingDataProvided          true.
  var:x ex:newAddressProvided          true.
  var:x ex:addressChangeDeclared       true.
  var:x ex:confirmationOfAddressChange false.
}.

# Confirmed (goal)
state:s5 :formula {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        true.
  var:x ex:movingDataProvided          true.
  var:x ex:newAddressProvided          true.
  var:x ex:addressChangeDeclared       true.
  var:x ex:confirmationOfAddressChange true.
}.

# =======================================================================================
# 2) Steps (OSLO-STEPS core) + costs
# =======================================================================================

# s0 -> s1
step:providePersonalInfoOnline a o-steps:Step;
  rdfs:label "Provide personal info (online)"@en;
  o-steps:requiresState state:s0;
  o-steps:producesState state:s1;
  cost:duration 30.0; cost:monetaryCost 0.0; cost:success 0.99;  cost:usersatifaction 0.95.

step:providePersonalInfoDesk a o-steps:Step;
  rdfs:label "Provide personal info (desk)"@en;
  o-steps:requiresState state:s0;
  o-steps:producesState state:s1;
  cost:duration 120.0; cost:monetaryCost 0.0; cost:success 0.995; cost:usersatifaction 0.85.

# s1 -> s2
step:provideMovingDataOnline a o-steps:Step;
  rdfs:label "Provide moving data (online)"@en;
  o-steps:requiresState state:s1;
  o-steps:producesState state:s2;
  cost:duration 45.0; cost:monetaryCost 2.0; cost:success 0.99;  cost:usersatifaction 0.92.

step:provideMovingDataDesk a o-steps:Step;
  rdfs:label "Provide moving data (desk)"@en;
  o-steps:requiresState state:s1;
  o-steps:producesState state:s2;
  cost:duration 90.0; cost:monetaryCost 2.0; cost:success 0.995; cost:usersatifaction 0.88.

# s2 -> s3
step:provideNewAddress a o-steps:Step;
  rdfs:label "Provide new address"@en;
  o-steps:requiresState state:s2;
  o-steps:producesState state:s3;
  cost:duration 30.0; cost:monetaryCost 0.0; cost:success 0.99;  cost:usersatifaction 0.93.

# s3 -> s4
step:declareAddressChangeOnline a o-steps:Step;
  rdfs:label "Declare address change (online)"@en;
  o-steps:requiresState state:s3;
  o-steps:producesState state:s4;
  cost:duration 60.0; cost:monetaryCost 0.0; cost:success 0.98;  cost:usersatifaction 0.90.

step:declareAddressChangePostal a o-steps:Step;
  rdfs:label "Declare address change (postal)"@en;
  o-steps:requiresState state:s3;
  o-steps:producesState state:s4;
  cost:duration 90.0; cost:monetaryCost 2.0; cost:success 0.95;  cost:usersatifaction 0.88.

# s4 -> s5
step:confirmAddressChangePolice a o-steps:Step;
  rdfs:label "Confirm address change (police visit)"@en;
  o-steps:requiresState state:s4;
  o-steps:producesState state:s5;
  cost:duration 20160.0; cost:monetaryCost 0.0; cost:success 0.98; cost:usersatifaction 0.97.

step:confirmAddressChangeCityHall a o-steps:Step;
  rdfs:label "Confirm address change (city hall)"@en;
  o-steps:requiresState state:s4;
  o-steps:producesState state:s5;
  cost:duration 10080.0; cost:monetaryCost 0.0; cost:success 0.90; cost:usersatifaction 0.85.

# =======================================================================================
# 3) Compile OSLO-STEPS core -> internal gps:description transitions
# =======================================================================================

{
  ex:movemap gps:description ( ?FROM true ?TO ?STEP ?DUR ?MC ?SUC ?SAT ).
} <=
{
  ?STEP a o-steps:Step.
  ?STEP o-steps:requiresState ?REQ.
  ?STEP o-steps:producesState ?PROD.

  ?REQ  :formula ?FROM.
  ?PROD :formula ?TO.

  ?STEP cost:duration ?DUR.
  ?STEP cost:monetaryCost ?MC.
  ?STEP cost:success ?SUC.
  ?STEP cost:usersatifaction ?SAT.
}.

# =======================================================================================
# 4) Start + planner (NO fuel; terminates because workflow is acyclic)
# =======================================================================================

:bob :start {
  var:x a o-persoon:Inwoner.
  var:x ex:personalInfoProvided        false.
  var:x ex:movingDataProvided          false.
  var:x ex:newAddressProvided          false.
  var:x ex:addressChangeDeclared       false.
  var:x ex:confirmationOfAddressChange false.
}.

# Base: one step is a path
{ (?From ?To (?Act) ?Dur ?Cost ?Suc ?Sat) :path true. }
<=
{ ex:movemap gps:description (?From true ?To ?Act ?Dur ?Cost ?Suc ?Sat). }.

# Recursive: step + rest, aggregate
{ (?From ?To ?Acts ?Dur ?Cost ?Suc ?Sat) :path true. }
<=
{
  ex:movemap gps:description (?From true ?Mid ?Act ?Dur1 ?Cost1 ?Suc1 ?Sat1).
  (?Mid ?To ?Rest ?Dur2 ?Cost2 ?Suc2 ?Sat2) :path true.

  ((?Act) ?Rest) list:append ?Acts.
  (?Dur1  ?Dur2)  math:sum     ?Dur.
  (?Cost1 ?Cost2) math:sum     ?Cost.
  (?Suc1  ?Suc2)  math:product ?Suc.
  (?Sat1  ?Sat2)  math:product ?Sat.
}.

# Wrapper: OSLO-like findpath with bounds
{
  :scope gps:findpath ( ?GOAL ?PATH ?DUR ?COST ?SUC ?SAT (?DL ?CL ?SL ?AL) ).
} <=
{
  :bob :start ?START.
  (?START ?GOAL ?PATH ?DUR ?COST ?SUC ?SAT) :path true.

  ?DUR  math:lessThan    ?DL.
  ?COST math:lessThan    ?CL.
  ?SUC  math:greaterThan ?SL.
  ?SAT  math:greaterThan ?AL.
}.

# =======================================================================================
# 5) Goal query -> output
# =======================================================================================

{
  state:s5 :formula ?GOAL.

  :scope gps:findpath
    (
      ?GOAL
      ?PATH ?DUR ?COST ?SUC ?SAT
      (
        40320.0  # duration limit (4 weeks)
        20.0     # monetary cost limit
        0.80     # success lower bound
        0.65     # satisfaction lower bound (product shrinks fast)
      )
    ).
}
=>
{
  :bob gps:path (?PATH ?DUR ?COST ?SUC ?SAT).
}.

