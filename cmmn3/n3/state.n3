@prefix in: <http://n3.w3c.org/builtin/input#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cond: <http://rdf.org/cond#> .
@prefix e: <http://eulersharp.sourceforge.net/2003/03swap/log-rules#>.
@prefix state: <http://rdf.org/state#> .
@prefix cm: <http://rdf.org/cmmn#> .

{ _:t state:init ?states }
<= {
    ( { ?item state:all ( ( ?type ( ?reason ) ) ) } { ?item state:in ( ?type ?reason ) } ?statemts )
        log:collectAllIn _:t .   

    ?statemts log:conjunction ?states
} .

{ ( ?item ?states ) state:isIn ( ?type { ?item state:all ?all } ) }
<= {
    ?states log:includes { ?item state:all ?all } .
    ?all list:last ( ?type ?desc ) .
} .

{ ( ?item ?states ) state:createNew ( ( ?type ?reason ) { ?item state:all ?all2 } ) } 
<= {
    ?states log:includes { ?item state:all ?all } .

    ?new log:equalTo ( ?type ( ?reason ) ) .
    ( ?item ?all ?new ) state:check ?new2 .

    ( ?all ( ?new2 ) ) list:append ?all2 .
} .