@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix fh: <http://hl7.org/fhir/> .
@prefix icd: <http://hl7.org/fhir/sid/icd-10/> .
@prefix sct: <http://snomed.info/id/> .
@prefix : <http://rdf.org/med/calc#> .

# CRB-65

{ ( ?p ?ctx ) :crb_65 ( ?terms ?score ) } 
<= {
    ( ?term { ( ?p ?ctx ) :crb_65_term ?term } ?terms )
        log:collectAllIn _:t .

    ?terms list:length ?score
} .

{ ( ?p ?ctx ) :crb_65_term "confusion" } 
<= {
    # "confusion" derived from diagnostic codes
    ?ctx log:includes { ?p!fh:subjectOf fh:code ?diagn } .
    ?diagn list:in ( icd:R410 icd:F058 icd:F448 icd:R55 icd:G4021 icd:G4020 icd:G4011 icd:G4010 )
} .

{ ( ?p ?ctx ) :crb_65_term "respiration" } 
<= {
    ?ctx log:includes {
        ?p fh:subjectOf ?o . 
        ?o fh:code sct:364062005 ; # respiration
            fh:value ?v .
    } .
    ?v math:notLessThan 30 
} .

{ ( ?p ?ctx ) :crb_65_term "BP" } 
<= { 
    ( ?p ?ctx ) :crb_65_bp ?nr .
} .

{ ( ?p ?ctx ) :crb_65_bp "dias" } 
<= {
    ?ctx log:includes {
        ?p fh:subjectOf ?o . 
        ?o fh:code sct:271649006 ; # systolic
            fh:value ?v .
    } .
    ?v math:lessThan 90 .
    true log:callWithCut true .
} .

{ ( ?p ?ctx ) :crb_65_bp "sys" } 
<= {
    ?ctx log:includes {
        ?p fh:subjectOf ?o . 
        ?o fh:code sct:271650006 ; # diastolic
            fh:value ?v .
    } .
    ?v math:notGreaterThan 60 .
    true log:callWithCut true .
} .

{ ( ?p ?ctx ) :crb_65_term "age" } 
<= {
    ?ctx log:includes { ?p fh:birthDate ?age . } . # TODO 
    ?age math:notLessThan 65
} .