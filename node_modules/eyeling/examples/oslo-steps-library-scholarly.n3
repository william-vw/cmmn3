# =======================================================================================
# OSLO-STEPS — minimal “Library / Scholarly access” workflow composition example
#
# Purpose
#   A compact, representative test case for Eyeling/EYE workflow composition in the
#   OSLO-STEPS style, without SHACL or shape machinery.
#
# What it models
#   A scholar (Alice) wants access to a scholarly item. The workflow progresses through
#   five “state flags”:
#     1) identityVerified
#     2) affiliationVerified
#     3) requestSubmitted
#     4) itemLocated
#     5) accessGranted
#
# OSLO-STEPS core used
#   - Each step is an o-steps:Step with:
#       o-steps:requiresState  (precondition state)
#       o-steps:producesState  (postcondition state)
#     plus simple costs:
#       cost:duration, cost:monetaryCost, cost:success, cost:usersatifaction
#
# State representation
#   - Each “State” is stored as a quoted N3 formula term in state:si :formula { ... }.
#   - We use var:x inside formulas as a stable placeholder to avoid variable-renaming
#     explosions and to keep formula-term matching predictable.
#
# Compilation and planning
#   - A small compiler turns each o-steps:Step into a gps:description transition:
#       (FROM true TO STEP duration cost success satisfaction)
#   - A minimal planner composes gps:description transitions into a gps:path by chaining
#     them and aggregating metrics:
#       duration + monetaryCost  = sum
#       success  * satisfaction  = product
#   - No “fuel” bound is used here; termination is ensured because the workflow graph is
#     acyclic (s0 -> s1 -> s2 -> s3 -> s4 -> s5) and has a finite number of alternatives.
#
# Output
#   - Derives :alice gps:path ( ?Steps ?Duration ?Cost ?Success ?Satisfaction ).
#
# Run (examples)
#   eye --quiet --nope --pass-only-new oslo-steps-library-scholarly-min.n3
#   node eyeling.js oslo-steps-library-scholarly-min.n3
# =======================================================================================

@prefix math: <http://www.w3.org/2000/10/swap/math#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix gps:  <https://eyereasoner.github.io/eye/reasoning/gps/gps-schema#>.
@prefix :     <https://eyereasoner.github.io/eye/reasoning#>.

@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix var:  <http://www.w3.org/2000/10/swap/var#>.
@prefix foaf: <http://xmlns.com/foaf/0.1/>.

@prefix o-steps: <https://fast.ilabt.imec.be/ns/oslo-steps#>.

@prefix ex:    <https://example.org/vocab#>.
@prefix cost:  <https://example.org/cost#>.
@prefix state: <https://example.org/states#>.
@prefix step:  <https://example.org/steps#>.

# -----------------------------------------------------------------------------
# 1) States as formula terms (no SHACL)
#
# State signature booleans (5):
#   ex:identityVerified        (can the scholar authenticate?)
#   ex:affiliationVerified     (is membership/affiliation confirmed?)
#   ex:requestSubmitted        (has the access request been submitted?)
#   ex:itemLocated             (did we locate a route to the item?)
#   ex:accessGranted           (final: scholar can access/download)
# -----------------------------------------------------------------------------

state:s0 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    false.
  var:x ex:affiliationVerified false.
  var:x ex:requestSubmitted    false.
  var:x ex:itemLocated         false.
  var:x ex:accessGranted       false.
}.

state:s1 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    true.
  var:x ex:affiliationVerified false.
  var:x ex:requestSubmitted    false.
  var:x ex:itemLocated         false.
  var:x ex:accessGranted       false.
}.

state:s2 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    true.
  var:x ex:affiliationVerified true.
  var:x ex:requestSubmitted    false.
  var:x ex:itemLocated         false.
  var:x ex:accessGranted       false.
}.

state:s3 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    true.
  var:x ex:affiliationVerified true.
  var:x ex:requestSubmitted    true.
  var:x ex:itemLocated         false.
  var:x ex:accessGranted       false.
}.

state:s4 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    true.
  var:x ex:affiliationVerified true.
  var:x ex:requestSubmitted    true.
  var:x ex:itemLocated         true.
  var:x ex:accessGranted       false.
}.

state:s5 :formula {
  var:x a foaf:Person.
  var:x ex:identityVerified    true.
  var:x ex:affiliationVerified true.
  var:x ex:requestSubmitted    true.
  var:x ex:itemLocated         true.
  var:x ex:accessGranted       true.
}.

# -----------------------------------------------------------------------------
# 2) Steps (OSLO-STEPS core) + costs
#
# Costs:
#   cost:duration        (minutes)
#   cost:monetaryCost    (arbitrary units)
#   cost:success         (0..1)
#   cost:usersatifaction (0..1)  (keep spelling consistent with earlier examples)
# -----------------------------------------------------------------------------

# s0 -> s1 (identity)
step:verifyIdentitySSO a o-steps:Step;
  rdfs:label "Verify identity (SSO)"@en;
  o-steps:requiresState state:s0; o-steps:producesState state:s1;
  cost:duration 2.0;   cost:monetaryCost 0.0; cost:success 0.97;  cost:usersatifaction 0.97.

step:verifyIdentityDesk a o-steps:Step;
  rdfs:label "Verify identity (library desk)"@en;
  o-steps:requiresState state:s0; o-steps:producesState state:s1;
  cost:duration 20.0;  cost:monetaryCost 0.0; cost:success 0.995; cost:usersatifaction 0.85.

# s1 -> s2 (affiliation)
step:verifyAffiliationAuto a o-steps:Step;
  rdfs:label "Verify affiliation (automatic)"@en;
  o-steps:requiresState state:s1; o-steps:producesState state:s2;
  cost:duration 3.0;   cost:monetaryCost 0.0; cost:success 0.98;  cost:usersatifaction 0.95.

step:verifyAffiliationManual a o-steps:Step;
  rdfs:label "Verify affiliation (manual approval)"@en;
  o-steps:requiresState state:s1; o-steps:producesState state:s2;
  cost:duration 240.0; cost:monetaryCost 0.0; cost:success 0.995; cost:usersatifaction 0.80.

# s2 -> s3 (submit request)
step:submitRequestSelfService a o-steps:Step;
  rdfs:label "Submit request (self-service form)"@en;
  o-steps:requiresState state:s2; o-steps:producesState state:s3;
  cost:duration 5.0;   cost:monetaryCost 0.0; cost:success 0.97;  cost:usersatifaction 0.94.

step:submitRequestLibrarian a o-steps:Step;
  rdfs:label "Submit request (with librarian)"@en;
  o-steps:requiresState state:s2; o-steps:producesState state:s3;
  cost:duration 15.0;  cost:monetaryCost 0.0; cost:success 0.99;  cost:usersatifaction 0.90.

# s3 -> s4 (locate item)
step:locateViaCatalogue a o-steps:Step;
  rdfs:label "Locate item (catalogue + resolver)"@en;
  o-steps:requiresState state:s3; o-steps:producesState state:s4;
  cost:duration 2.0;   cost:monetaryCost 0.0; cost:success 0.96;  cost:usersatifaction 0.92.

step:locateViaDiscovery a o-steps:Step;
  rdfs:label "Locate item (discovery index)"@en;
  o-steps:requiresState state:s3; o-steps:producesState state:s4;
  cost:duration 3.0;   cost:monetaryCost 0.0; cost:success 0.97;  cost:usersatifaction 0.93.

# s4 -> s5 (grant access)
step:grantAccessOpenAccess a o-steps:Step;
  rdfs:label "Grant access (open access)"@en;
  o-steps:requiresState state:s4; o-steps:producesState state:s5;
  cost:duration 1.0;   cost:monetaryCost 0.0; cost:success 0.92;  cost:usersatifaction 0.97.

step:grantAccessSubscription a o-steps:Step;
  rdfs:label "Grant access (subscription)"@en;
  o-steps:requiresState state:s4; o-steps:producesState state:s5;
  cost:duration 2.0;   cost:monetaryCost 0.5; cost:success 0.97;  cost:usersatifaction 0.94.

step:grantAccessInterlibraryLoan a o-steps:Step;
  rdfs:label "Grant access (interlibrary loan)"@en;
  o-steps:requiresState state:s4; o-steps:producesState state:s5;
  cost:duration 2880.0; cost:monetaryCost 5.0; cost:success 0.985; cost:usersatifaction 0.80.

# -----------------------------------------------------------------------------
# 3) Compile OSLO-STEPS core -> internal gps:description transitions
# -----------------------------------------------------------------------------

{
  ex:libmap gps:description ( ?FROM true ?TO ?STEP ?DUR ?MC ?SUC ?SAT ).
} <=
{
  ?STEP a o-steps:Step.
  ?STEP o-steps:requiresState ?REQ.
  ?STEP o-steps:producesState ?PROD.

  ?REQ  :formula ?FROM.
  ?PROD :formula ?TO.

  ?STEP cost:duration ?DUR.
  ?STEP cost:monetaryCost ?MC.
  ?STEP cost:success ?SUC.
  ?STEP cost:usersatifaction ?SAT.
}.

# -----------------------------------------------------------------------------
# 4) Start + planner (NO fuel; terminates because workflow is acyclic)
# -----------------------------------------------------------------------------

:alice :start {
  var:x a foaf:Person.
  var:x ex:identityVerified    false.
  var:x ex:affiliationVerified false.
  var:x ex:requestSubmitted    false.
  var:x ex:itemLocated         false.
  var:x ex:accessGranted       false.
}.

# Base: one step is a path
{ (?From ?To (?Act) ?Dur ?Cost ?Suc ?Sat) :path true. }
<=
{ ex:libmap gps:description (?From true ?To ?Act ?Dur ?Cost ?Suc ?Sat). }.

# Recursive: step + rest, aggregate
{ (?From ?To ?Acts ?Dur ?Cost ?Suc ?Sat) :path true. }
<=
{
  ex:libmap gps:description (?From true ?Mid ?Act ?Dur1 ?Cost1 ?Suc1 ?Sat1).
  (?Mid ?To ?Rest ?Dur2 ?Cost2 ?Suc2 ?Sat2) :path true.

  ((?Act) ?Rest) list:append ?Acts.
  (?Dur1  ?Dur2)  math:sum     ?Dur.
  (?Cost1 ?Cost2) math:sum     ?Cost.
  (?Suc1  ?Suc2)  math:product ?Suc.
  (?Sat1  ?Sat2)  math:product ?Sat.
}.

# Wrapper: OSLO-like findpath with bounds
{
  :scope gps:findpath ( ?GOAL ?PATH ?DUR ?COST ?SUC ?SAT (?DL ?CL ?SL ?AL) ).
} <=
{
  :alice :start ?START.
  (?START ?GOAL ?PATH ?DUR ?COST ?SUC ?SAT) :path true.

  ?DUR  math:lessThan    ?DL.
  ?COST math:lessThan    ?CL.
  ?SUC  math:greaterThan ?SL.
  ?SAT  math:greaterThan ?AL.
}.

# -----------------------------------------------------------------------------
# 5) Goal query -> output
# -----------------------------------------------------------------------------

{
  state:s5 :formula ?GOAL.

  :scope gps:findpath
    (
      ?GOAL
      ?PATH ?DUR ?COST ?SUC ?SAT
      (
        5000.0   # duration limit (minutes)
        10.0     # monetary cost limit
        0.75     # success lower bound
        0.60     # satisfaction lower bound (product shrinks fast)
      )
    ).
}
=>
{
  :alice gps:path (?PATH ?DUR ?COST ?SUC ?SAT).
}.

