# ========================================================================================
# Drone Corridor Planner (example N3 program)
#
# What this file is
# - A tiny “planner” written in Notation3 (N3): it searches for a sequence of
#   actions that moves a drone from a start state to a goal state.
# - Intended to run in an N3 reasoner that supports forward rules (`=>`),
#   backward rules (`<=`), and a few built-ins (e.g., `math:*`, `list:*`).
#
# How to run (one simple option)
# - With the JavaScript `eyeling` CLI:
#     npx eyeling examples/drone-corridor-planner.n3
#   The output will be newly derived facts, including one or more `gps:plan`
#   results (see “Output” below).
#
# Big idea (in plain terms)
# - We describe a “world” as a small set of facts: location, battery level,
#   and whether the drone has a permit.
# - We describe each possible action (fly, train, charge, buy/get permit) as a
#   state transition:  FROM-state  ->  TO-state  plus some numeric “weights”.
# - The rules then *compose* these transitions into multi-step plans while
#   aggregating the weights (e.g., add durations, multiply beliefs).
#
# Reading the action descriptions
# - Each action is encoded as a `gps:description` with this shape:
#     ( FROM  true  TO  :actionName  duration  cost  belief  comfort )
#   where:
#   - FROM / TO are little graphs in `{ ... }` describing the state.
#   - `true` is a placeholder “precondition” (kept for symmetry with richer
#     variants where extra conditions may appear).
#   - duration/cost/belief/comfort are example numbers used for scoring/pruning.
#
# Bounded search (why it doesn’t loop forever)
# - The planner is *fuel-bounded*: it carries a list of “fuel tokens” and
#   consumes one token per step. When fuel runs out, expansion stops.
# - This is important because the map can contain cycles (e.g., going back to a
#   previous city). Fuel-bounding keeps the search safe and finite.
#
# How scores are combined across a multi-step plan
# - Duration and cost are summed.
# - Belief and comfort are multiplied (so long plans tend to reduce them).
# - The list of actions is built by appending each step’s action name.
#
# Output (what you should expect to see)
# - The “Query” section asks for plans that take the drone from the initial
#   state to the goal (Oostende), then prunes bad plans using thresholds like:
#     belief > ...  and  cost < ...
# - Each surviving plan is reported as a derived fact like:
#     :d1 gps:plan ( ...actions... duration cost belief comfort battery permit fuelLeft ).
#
# Customizing this example
# - Add/edit `gps:description` lines to introduce new routes/actions.
# - Change the initial state (`:d1 :location ...`, `:battery ...`, `:permit ...`).
# - Adjust `:fuel7` (more/less steps) and the pruning thresholds in the Query.
#
# Notes
# - This is a *toy* corridor-planning model meant to illustrate rule-based
#   planning patterns. The numeric values and “units” are illustrative.
# ========================================================================================

@prefix math: <http://www.w3.org/2000/10/swap/math#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix gps:  <https://eyereasoner.github.io/eye/reasoning/gps/gps-schema#>.
@prefix :     <https://eyereasoner.github.io/eye/reasoning#>.

# -------------
# current state
# -------------
:d1 :location :Gent.
:d1 :battery  :full.
:d1 :permit   :none.

# bounded search horizon (7 steps max)
:fuel7 :value (:t :t :t :t :t :t :t).

# -----------------------------------------------------------------
# "map" / action descriptions (as backward rules)
# State = { ?S :location ... . ?S :battery ... . ?S :permit ... . }
# -----------------------------------------------------------------
# two ways to reach Brugge (tradeoff: cost/comfort)
{:map-DRONE gps:description (
  {?S :location :Gent.   ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :mid.  ?S :permit ?P.}
  :fly_gent_brugge
  1500.0 0.006 0.99 0.99
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Gent.   ?S :battery ?B.    ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery ?B.    ?S :permit ?P.}
  :train_gent_brugge
  1700.0 0.012 0.999 0.995
)} <= true.

# via Kortrijk (permit + charging opportunities)
{:map-DRONE gps:description (
  {?S :location :Gent.     ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :mid.  ?S :permit ?P.}
  :fly_gent_kortrijk
  1600.0 0.007 0.99 0.99
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :mid.  ?S :permit ?P.} true
  {?S :location :Brugge.   ?S :battery :low.  ?S :permit ?P.}
  :fly_kortrijk_brugge
  1600.0 0.007 0.99 0.99
)} <= true.

# cycle edge (safe due to fuel bound; typically pruned by belief threshold)
{:map-DRONE gps:description (
  {?S :location :Brugge.   ?S :battery :mid.  ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :low.  ?S :permit ?P.}
  :fly_brugge_kortrijk
  1600.0 0.007 0.985 0.98
)} <= true.

# get permit in Kortrijk (best belief)
{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery ?B. ?S :permit :none.} true
  {?S :location :Kortrijk. ?S :battery ?B. ?S :permit :yes.}
  :get_zone_permit_kortrijk
  300.0 0.001 0.999 1.0
)} <= true.

# get permit in Brugge (faster, but lower belief)
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery ?B. ?S :permit :none.} true
  {?S :location :Brugge. ?S :battery ?B. ?S :permit :yes.}
  :buy_permit_brugge
  450.0 0.002 0.98 1.0
)} <= true.

# charging options
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :low. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.}
  :quick_charge_brugge
  600.0 0.004 0.999 0.97
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.}
  :topup_brugge
  400.0 0.003 0.999 0.98
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :full. ?S :permit ?P.}
  :emergency_charge_kortrijk
  500.0 0.003 0.999 0.95
)} <= true.

# to Oostende: three alternatives
# A) restricted corridor: fastest+comfortable, but requires permit=yes and full battery
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :full. ?S :permit :yes.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit :yes.}
  :cross_corridor_brugge_oostende
  900.0 0.004 0.98 1.0
)} <= true.

# B) public coastline: no permit required, slower
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Oostende. ?S :battery :low. ?S :permit ?P.}
  :public_coastline_brugge_oostende
  1300.0 0.006 0.97 0.96
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit ?P.}
  :public_coastline_brugge_oostende
  1200.0 0.006 0.975 0.96
)} <= true.

# C) Kortrijk shortcut: requires permit and full battery; quicker but lower comfort
{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :full. ?S :permit :yes.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit :yes.}
  :direct_corridor_kortrijk_oostende
  1100.0 0.009 0.955 0.92
)} <= true.

# ----------------------------------
# planner: compute all bounded paths
# ----------------------------------
# Base: one description is a path (consume 1 fuel token)
{
  (?From ?To (?Act) ?Dur ?Cost ?Bel ?Comf ?FuelIn ?FuelOut) :path true.
}
<=
{
  :map-DRONE gps:description (?From true ?To ?Act ?Dur ?Cost ?Bel ?Comf).
  ?FuelIn list:rest ?FuelOut.
}.

# Recursive: chain one step + rest path, aggregate weights, consume 1 fuel token
{
  (?From ?To ?Actions ?Dur ?Cost ?Bel ?Comf ?FuelIn ?FuelOut) :path true.
}
<=
{
  :map-DRONE gps:description (?From true ?Mid ?Act ?Dur1 ?Cost1 ?Bel1 ?Comf1).

  ?FuelIn list:rest ?FuelMid.
  (?Mid ?To ?RestActs ?Dur2 ?Cost2 ?Bel2 ?Comf2 ?FuelMid ?FuelOut) :path true.

  ((?Act) ?RestActs) list:append ?Actions.

  (?Dur1  ?Dur2)  math:sum     ?Dur.
  (?Cost1 ?Cost2) math:sum     ?Cost.
  (?Bel1  ?Bel2)  math:product ?Bel.
  (?Comf1 ?Comf2) math:product ?Comf.
}.

# -------------------------------------------------------
# Query: plans for d1 to Oostende with pruning thresholds
# -------------------------------------------------------
{
  :fuel7 :value ?Fuel.

  ({:d1 :location :Gent. :d1 :battery :full. :d1 :permit :none.}
   {:d1 :location :Oostende. :d1 :battery ?B. :d1 :permit ?P.}
   ?Acts ?Dur ?Cost ?Bel ?Comf ?Fuel ?FuelLeft) :path true.

  ?Bel  math:greaterThan 0.94.
  ?Cost math:lessThan    0.03.
}
=>
{
  :d1 gps:plan (?Acts ?Dur ?Cost ?Bel ?Comf ?B ?P ?FuelLeft).
}.

