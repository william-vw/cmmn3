# ===========================
# get UUID
# Example from Wout Slabbinck
# ===========================

@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix crypto: <http://www.w3.org/2000/10/swap/crypto#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/>.
@prefix : <http://example.org/ns#> .

# uuid backward rule (component)
{
   ?input :getUUID ?urnUuid
}
<=
{
   # 0. add some skolem uri to introduce randomness when there are multiple runs with the same ID
  ( "test" ) log:skolem ?skolem .
  (?input (?skolem) ) list:append ?newList .

   # 1. Convert input to a stable string
   ?newList :listToString ?inputString .

   # 2. Generate a stable hash (works identically in 2026 eyeJS and Eyeling)
    ?inputString  crypto:sha ?hash .

   # 3. Format the hash into a UUID-compliant structure (8-4-4-4-12)
   ( ?hash "^(.{8}).*$" ) string:scrape ?p1 .
   ( ?hash "^.{8}(.{4}).*$" ) string:scrape ?p2 .
   ( ?hash "^.{12}(.{4}).*$" ) string:scrape ?p3 .
   ( ?hash "^.{16}(.{4}).*$" ) string:scrape ?p4 .
   ( ?hash "^.{20}(.{12}).*$" ) string:scrape ?p5 .
   ( "urn:uuid:" ?p1 "-" ?p2 "-" ?p3 "-" ?p4 "-" ?p5 ) string:concatenation ?urnUuidString .

   # 4. Cast the final string to a URI
   ?urnUuid log:uri ?urnUuidString .
} .

# 1. Base Case: An empty list results in an empty string
{ () :listToString "" } <= { } .

# 2. Recursive Case: Process list using rdf:first and rdf:rest
{ ?list :listToString ?result } <= {
    ?list rdf:first ?head .
    ?list rdf:rest ?tail .

    # Convert the current URI to a string
    ?head log:uri ?headStr .

    # Recursively convert the tail of the list
    ?tail :listToString ?tailStr .

    # Combine head and tail strings
    ( ?headStr ?tailStr ) string:concatenation ?result .
} .

<test> a odrl:Policy  .
<lol> a odrl:Policy .

{
    ?policy a odrl:Policy .
    ( ?policy ) :getUUID ?urnUuid .
}
=>
{ ?urnUuid <a> <b> } .

